#!/bin/bash
#! Script to build the whole project when its your firstday
set -e

MAVEN_OPTS="-Xmx6000m -XX:MaxPermSize=4000m"
JAVA_HOME=/usr/lib/jvm/java-7-oracle
JRE_HOME=$JAVA_HOME/jre
CLASSPATH=.:$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH
PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH

echo "MAVEN_OPTS=$MAVEN_OPTS"

function usage() {
	echo "USAGE: $0 [-clean] hive/spark/idbc/inceptor/all"
}

if [[ -z $DEVROOT ]]; then
	  echo "export DEVROOT=/path/to/projects; then continue"
	  exit 0;
fi

HIVE=hive-0.12.0-transwarp
NGMR=ngmr-1.7-transwarp
THISPATH=$(cd ${0%/*} && echo $PWD/${0##*/})
ACTIONS=("hive" "spark" "idbc" "inceptor" "all")
CLEAN="false"
ACTION=${@:$#}

# Check CLI options
if [ $# -lt 1 ]; then
    usage && exit 1;
fi

while [ $# -gt 0 ]; do
  COMMAND=$1
  case $COMMAND in
    -clean)
      CLEAN="true" && shift;;
    *)
      break;;
  esac
done

if [[ "${ACTIONS[@]}" =~ "${ACTION}" ]]; then
    echo ">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>"
    echo "mvn clean: $CLEAN"
    echo "target: $ACTION"
    echo ""
    echo "DEVROOT=$DEVROOT"
    echo "HIVE=$DEVROOT/$HIVE"
    echo "NGMR=$DEVROOT/$NGMR"
    echo "<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<"
    while true; do
        read -p "Do you want to compile using above configurations? (y/n) " yn
        case $yn in
            [Yy]* ) break;;
            [Nn]* ) exit;;
            * ) echo "Please answer yes or no.";;
        esac
    done
else
    usage && exit 1;
fi

function build_hive() {
    cd $DEVROOT/$HIVE/src
    if [[ $ACTION == "hive" || $ACTION == "all" ]]; then
        if [[ $CLEAN == "true" ]]; then mvn clean; fi
        mvn package install -DskipTests -Pidea
    fi
}

function build_spark() {
    cd $DEVROOT/$NGMR/spark
    if [[ $ACTION == "spark" || $ACTION == "all" ]]; then
        if [[ $CLEAN == "true" ]]; then mvn clean; fi
        mvn package install -DskipTests -Pyarn -Pidea
    fi  
}

function build_idbc() {
    cd $DEVROOT/$NGMR/idbc
    if [[ $ACTION == "idbc" || $ACTION == "all" ]]; then
        if [[ $CLEAN == "true" ]]; then mvn clean; fi
        mvn package install -DskipTests
    fi
}

function build_inceptor() {
    cd $DEVROOT/$NGMR/inceptor
    if [[ $ACTION == "inceptor" || $ACTION == "all" ]]; then
        if [[ $CLEAN == "true" ]]; then mvn clean; fi
        mvn package install -Dmaven.test.skip=true -Pidea
    fi
}

build_hive
build_spark
build_idbc
build_inceptor

## Copy compiled packages for regression tests
SYNC_BINARY=$(dirname $THISPATH)/sync-firstday
if [ -e $SYNC_BINARY ]; then
	bash $SYNC_BINARY
fi

exit 0;

#!/bin/bash
#! Script to build the whole project when its your firstday
set -e
export MAVEN_OPTS="-Xmx6192m -Xms4096m -XX:MaxNewSize=4096m -XX:MaxPermSize=4096m"

function usage() {
	echo "USAGE: $0 [-clean] hive/spark/idbc/inceptor/all"
}

if [[ -z $DEVROOT ]]; then
	  echo "export DEVROOT=/path/to/projects; then continue"
	  exit 0;
fi

THISPATH=$(cd ${0%/*} && echo $PWD/${0##*/})
HIVE=hive-0.12.0-transwarp
NGMR=ngmr-1.7-transwarp
ACTIONS=("hive" "spark" "idbc" "inceptor" "all")
CLEAN="false"
ACTION=${@:$#}

# Check CLI options
if [ $# -lt 1 ]; then
    usage && exit 1;
fi

while [ $# -gt 0 ]; do
  COMMAND=$1
  case $COMMAND in
    -clean)
      CLEAN="true" && shift;;
    *)
      break;;
  esac
done

if [[ "${ACTIONS[@]}" =~ "${ACTION}" ]]; then
    echo ">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>"
    echo "mvn clean == $CLEAN"
    echo "target == $ACTION"
    echo "DEVROOT=$DEVROOT"
    echo "HIVE=$DEVROOT/$HIVE"
    echo "NGMR=$DEVROOT/$NGMR"
    echo "<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<"
    while true; do
        read -p "Do you want to compile using above configurations? (y/n) " yn
        case $yn in
            [Yy]* ) break;;
            [Nn]* ) exit;;
            * ) echo "Please answer yes or no.";;
        esac
    done
else
    usage && exit 1;
fi

cd $DEVROOT/$HIVE/src
if [[ $ACTION == "hive" || $ACTION == "all" ]]; then
    if [[ $CLEAN == "true" ]]; then mvn clean; fi
    mvn package install -DskipTests -Pidea
fi

cd $DEVROOT/$NGMR/spark
if [[ $ACTION == "spark" || $ACTION == "all" ]]; then
    if [[ $CLEAN == "true" ]]; then mvn clean; fi
    mvn package install -DskipTests -Pyarn -Pidea
fi

cd $DEVROOT/$NGMR/idbc
if [[ $ACTION == "idbc" || $ACTION == "all" ]]; then
    if [[ $CLEAN == "true" ]]; then mvn clean; fi
    mvn package install -DskipTests
fi

cd $DEVROOT/$NGMR/inceptor
if [[ $ACTION == "inceptor" || $ACTION == "all" ]]; then
    if [[ $CLEAN == "true" ]]; then mvn clean; fi
    mvn package install -Dmaven.test.skip=true -Pidea
fi

$(dirname $THISPATH)/sync-firstday
